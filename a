local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

local lp = Players.LocalPlayer
local Shared = getgenv().SchmecktHubPC or {}
local key = "PurchasePanel"

local IS_MOBILE = Shared.Platform == "Mobile" or UserInputService.TouchEnabled
local SCALE = IS_MOBILE and 0.5 or 1

local function s(v) return math.floor(v * SCALE) end

local CLICK_SOUND_ID = "rbxassetid://100809160609628"
local INTRO_LOGO_ASSET = "rbxassetid://121759217057084"

local clickSound = SoundService:FindFirstChild("SchmecktClickSound")
if not clickSound then
    clickSound = Instance.new("Sound")
    clickSound.Name = "SchmecktClickSound"
    clickSound.SoundId = CLICK_SOUND_ID
    clickSound.Volume = 0.5
    clickSound.Parent = SoundService
end

local function playClick()
    task.spawn(function()
        pcall(function() clickSound:Stop() clickSound:Play() end)
    end)
end

Shared.Connections = Shared.Connections or {}
if Shared.Connections[key] then
    for _, c in pairs(Shared.Connections[key]) do
        if c then pcall(function() c:Disconnect() end) end
    end
end
Shared.Connections[key] = {}

local old = CoreGui:FindFirstChild("SchmecktPurchasePanel")
if old then old:Destroy() end

local COL = {
    BgMain    = Color3.fromRGB(90, 0, 0),
    BgTop     = Color3.fromRGB(140, 0, 0),
    BgInner   = Color3.fromRGB(120, 0, 0),
    Card      = Color3.fromRGB(135, 0, 0),
    Stroke1   = Color3.fromRGB(255, 110, 110),
    Stroke2   = Color3.fromRGB(255, 150, 150),
    Text      = Color3.fromRGB(255, 255, 255),
    DevText   = Color3.fromRGB(200, 160, 160),
    BtnBuy    = Color3.fromRGB(200, 30, 30),
    Success   = Color3.fromRGB(50, 255, 120),
    Danger    = Color3.fromRGB(255, 50, 50),
    DotRed    = Color3.fromRGB(255, 50, 50),
    DotGreen  = Color3.fromRGB(50, 255, 100),
    DotBlue   = Color3.fromRGB(100, 150, 255),
}

local function corner(inst, px)
    local c = Instance.new("UICorner"); c.CornerRadius = UDim.new(0, px or s(10)); c.Parent = inst; return c
end
local function strokeUI(inst, color, thickness, transparency)
    local st = Instance.new("UIStroke"); st.Color = color; st.Thickness = thickness or 1; st.Transparency = transparency or 0; st.Parent = inst; return st
end

local items = {
    {name = "[Tactical Shotgun]", display = "Tactical Shotgun", color = COL.DotRed},
    {name = "[Silencer]", display = "Silencer", color = COL.DotRed},
    {name = "[USP]", display = "USP", color = COL.DotRed},
    {name = "[Pizza]", display = "Pizza", color = COL.DotGreen},
    {name = "[Medium Armor]", display = "Medium Armor", color = COL.DotBlue},
}

local function getPad(padName)
    local map = Workspace:FindFirstChild("MAP")
    if not map then return nil end
    local pads = map:FindFirstChild("Pads")
    if not pads then return nil end
    for _, v in ipairs(pads:GetChildren()) do
        if v.Name == padName and v:FindFirstChild("ClickDetector") then return v end
    end
    for _, v in ipairs(pads:GetChildren()) do
        if string.find(v.Name, padName:gsub("%[", ""):gsub("%]", "")) and v:FindFirstChild("ClickDetector") then return v end
    end
    return nil
end

local gui = Instance.new("ScreenGui")
gui.Name = "SchmecktPurchasePanel"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = CoreGui

local ROW_H = s(30)
local GAP = s(4)
local headerH = s(46)
local itemCount = #items
local contentPad = s(8)
local contentInner = (ROW_H * itemCount) + (GAP * (itemCount - 1)) + contentPad * 2
local panelW = s(240)
local panelH = headerH + s(6) + contentInner + s(14)

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, panelW, 0, panelH)
MainFrame.Position = UDim2.new(1, -(panelW + s(20)), 1, -(panelH + s(310)))
MainFrame.BackgroundColor3 = COL.BgMain
MainFrame.BorderSizePixel = 0
MainFrame.Parent = gui
corner(MainFrame, s(14))
strokeUI(MainFrame, COL.Stroke1, s(2), 0)

local HeaderFrame = Instance.new("Frame")
HeaderFrame.Size = UDim2.new(1, -s(12), 0, headerH)
HeaderFrame.Position = UDim2.new(0, s(6), 0, s(6))
HeaderFrame.BackgroundColor3 = COL.BgTop
HeaderFrame.BorderSizePixel = 0
HeaderFrame.Parent = MainFrame
corner(HeaderFrame, s(12))
strokeUI(HeaderFrame, COL.Stroke2, 1, 0.15)

local headerGrad = Instance.new("UIGradient")
headerGrad.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(165, 0, 0)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(120, 0, 0)),
})
headerGrad.Parent = HeaderFrame

local headerLogo = Instance.new("ImageLabel")
headerLogo.Size = UDim2.new(0, s(26), 0, s(26))
headerLogo.Position = UDim2.new(0, s(8), 0.5, -s(13))
headerLogo.BackgroundTransparency = 1
headerLogo.Image = INTRO_LOGO_ASSET
headerLogo.ScaleType = Enum.ScaleType.Crop
headerLogo.ZIndex = 4
headerLogo.Parent = HeaderFrame
corner(headerLogo, s(999))
strokeUI(headerLogo, COL.Stroke2, 1, 0.3)

local headerTitle = Instance.new("TextLabel")
headerTitle.Size = UDim2.new(1, -s(50), 0, s(18))
headerTitle.Position = UDim2.new(0, s(40), 0, s(4))
headerTitle.BackgroundTransparency = 1
headerTitle.Text = "PURCHASE"
headerTitle.Font = Enum.Font.GothamBlack
headerTitle.TextSize = s(11)
headerTitle.TextColor3 = COL.Text
headerTitle.TextXAlignment = Enum.TextXAlignment.Left
headerTitle.ZIndex = 4
headerTitle.Parent = HeaderFrame

local headerSub = Instance.new("TextLabel")
headerSub.Size = UDim2.new(1, -s(50), 0, s(12))
headerSub.Position = UDim2.new(0, s(40), 0, s(24))
headerSub.BackgroundTransparency = 1
headerSub.Text = "developed by schmeckt"
headerSub.Font = Enum.Font.Gotham
headerSub.TextSize = s(9)
headerSub.TextColor3 = COL.DevText
headerSub.TextXAlignment = Enum.TextXAlignment.Left
headerSub.ZIndex = 4
headerSub.Parent = HeaderFrame

local contentY = headerH + s(12)

local ContentFrame = Instance.new("Frame")
ContentFrame.Size = UDim2.new(1, -s(12), 0, contentInner)
ContentFrame.Position = UDim2.new(0, s(6), 0, contentY)
ContentFrame.BackgroundColor3 = COL.BgInner
ContentFrame.BorderSizePixel = 0
ContentFrame.Parent = MainFrame
corner(ContentFrame, s(12))
strokeUI(ContentFrame, COL.Stroke2, 1, 0.25)

local InnerContainer = Instance.new("Frame")
InnerContainer.Size = UDim2.new(1, -contentPad * 2, 1, -contentPad * 2)
InnerContainer.Position = UDim2.new(0, contentPad, 0, contentPad)
InnerContainer.BackgroundTransparency = 1
InnerContainer.Parent = ContentFrame

local ListLayout = Instance.new("UIListLayout")
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
ListLayout.Padding = UDim.new(0, GAP)
ListLayout.Parent = InnerContainer

for i, item in ipairs(items) do
    local Row = Instance.new("Frame")
    Row.Size = UDim2.new(1, 0, 0, ROW_H)
    Row.BackgroundColor3 = COL.Card
    Row.BorderSizePixel = 0
    Row.LayoutOrder = i
    Row.Parent = InnerContainer
    corner(Row, s(8))
    strokeUI(Row, COL.Stroke2, 1, 0.4)

    local ColorDot = Instance.new("Frame")
    ColorDot.Size = UDim2.new(0, s(6), 0, s(6))
    ColorDot.Position = UDim2.new(0, s(10), 0.5, -s(3))
    ColorDot.BackgroundColor3 = item.color
    ColorDot.BorderSizePixel = 0
    ColorDot.ZIndex = 5
    ColorDot.Parent = Row
    corner(ColorDot, s(999))

    local ItemLabel = Instance.new("TextLabel")
    ItemLabel.Size = UDim2.new(1, -s(80), 1, 0)
    ItemLabel.Position = UDim2.new(0, s(22), 0, 0)
    ItemLabel.BackgroundTransparency = 1
    ItemLabel.Text = item.display
    ItemLabel.Font = Enum.Font.GothamBold
    ItemLabel.TextSize = s(11)
    ItemLabel.TextColor3 = COL.Text
    ItemLabel.TextXAlignment = Enum.TextXAlignment.Left
    ItemLabel.TextTruncate = Enum.TextTruncate.AtEnd
    ItemLabel.ZIndex = 5
    ItemLabel.Parent = Row

    local BuyBtn = Instance.new("TextButton")
    BuyBtn.AutoButtonColor = false
    BuyBtn.AnchorPoint = Vector2.new(1, 0.5)
    BuyBtn.Position = UDim2.new(1, -s(6), 0.5, 0)
    BuyBtn.Size = UDim2.new(0, s(45), 0, s(20))
    BuyBtn.BackgroundColor3 = COL.BtnBuy
    BuyBtn.Text = "BUY"
    BuyBtn.TextColor3 = COL.Text
    BuyBtn.Font = Enum.Font.GothamBold
    BuyBtn.TextSize = s(9)
    BuyBtn.ZIndex = 6
    BuyBtn.Parent = Row
    corner(BuyBtn, s(999))
    strokeUI(BuyBtn, COL.Stroke2, 1, 0.5)

    BuyBtn.MouseButton1Click:Connect(function()
        playClick()
        local pad = getPad(item.name)
        if pad and pad:FindFirstChild("ClickDetector") and fireclickdetector then
            fireclickdetector(pad.ClickDetector)
            TweenService:Create(BuyBtn, TweenInfo.new(0.1), {BackgroundColor3 = COL.Success}):Play()
            BuyBtn.Text = "OK"
            task.wait(0.5)
            TweenService:Create(BuyBtn, TweenInfo.new(0.15), {BackgroundColor3 = COL.BtnBuy}):Play()
            BuyBtn.Text = "BUY"
        else
            TweenService:Create(BuyBtn, TweenInfo.new(0.1), {BackgroundColor3 = COL.Danger}):Play()
            BuyBtn.Text = "X"
            task.wait(0.5)
            TweenService:Create(BuyBtn, TweenInfo.new(0.15), {BackgroundColor3 = COL.BtnBuy}):Play()
            BuyBtn.Text = "BUY"
        end
    end)
end

local dragging, dragInput, dragStart, startPos
HeaderFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
HeaderFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

local FINAL_SIZE = UDim2.new(0, panelW, 0, panelH)
MainFrame.Size = UDim2.new(0, 0, 0, 0)
TweenService:Create(MainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = FINAL_SIZE}):Play()

local cleanupListener = RunService.RenderStepped:Connect(function()
    if not Shared.PurchasePanel then
        if gui then gui:Destroy() end
        cleanupListener:Disconnect()
        if Shared.Connections[key] then
            for _, c in pairs(Shared.Connections[key]) do
                pcall(function() c:Disconnect() end)
            end
            Shared.Connections[key] = {}
        end
    end
end)
table.insert(Shared.Connections[key], cleanupListener)
